<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/widget.js | meeseOS Widget API</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="meeseOS Panel API Documentation"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="meeseOS Widget API"><meta property="twitter:description" content="meeseOS Panel API Documentation"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/meeseOS/meeseOS.git"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/provider.js~WidgetServiceProvider.html">WidgetServiceProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#items">items</a><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AnalogClockColors">AnalogClockColors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AnalogClockOptions">AnalogClockOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-DigitalClockOptions">DigitalClockOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Quote">Quote</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-QuoteDisplayOptions">QuoteDisplayOptions</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/widget.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * OS.js - JavaScript Cloud/Web Desktop Platform
 *
 * Copyright (c) 2011-Present, Anders Evenrud &lt;andersevenrud@gmail.com&gt;
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice, this
 *    list of conditions and the following disclaimer
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * @author  Anders Evenrud &lt;andersevenrud@gmail.com&gt;
 * @licence Simplified BSD License
 */

import merge from &quot;deepmerge&quot;;

const MIN_WIDTH = 200;
const MIN_HEIGHT = 200;
const MAX_WIDTH = 800;
const MAX_HEIGHT = 800;
const DEFAULT_MARGIN = 15;
const EMIT_TIMEOUT = 44;
const isNull = (val) =&gt; typeof val === &quot;undefined&quot; || val === null;

const getPosition = (core, position, nullValue = null) =&gt; {
	const rect = core.destroyed ? {} : core.make(&quot;meeseOS/desktop&quot;).getRect();

	let { top, left, right, bottom } = position;

	if (isNull(left) &amp;&amp; isNull(right)) {
		left = rect.left + DEFAULT_MARGIN;
	} else if (!isNull(left)) {
		right = nullValue;
	} else {
		left = nullValue;
	}

	if (isNull(top) &amp;&amp; isNull(bottom)) {
		top = rect.top + DEFAULT_MARGIN;
	} else if (!isNull(top)) {
		bottom = nullValue;
	} else {
		top = nullValue;
	}

	return { top, left, right, bottom };
};

const animator = (fps, stopFn) =&gt; {
	const interval = 1000 / fps;
	let last = performance.now();

	const animate = (cb) =&gt; {
		const now = performance.now();
		const elapsed = now - last;

		if (elapsed &gt; interval) {
			last = now - (elapsed % interval);

			cb();
		}

		if (!stopFn()) {
			requestAnimationFrame(() =&gt; animate(cb));
		}
	};

	return animate;
};

/**
 * Serves as the mouse down handler for the widget.
 * @param {MouseEvent} ev The mouse event
 * @param {Element} $root The root element
 * @param {Widget} widget The widget instance
 */
const onmousedown = (ev, $root, widget) =&gt; {
	let debounce;
	const startX = ev.clientX;
	const startY = ev.clientY;
	const startPosition = {
		left: widget.$element.offsetLeft,
		top: widget.$element.offsetTop,
	};
	const startDimension = { ...widget.options.dimension };
	const resize = ev.target.classList.contains(&quot;meeseOS-widget-resize&quot;);
	const { minDimension, maxDimension } = widget.attributes;

	const mousemove = (ev) =&gt; {
		const diffX = ev.clientX - startX;
		const diffY = ev.clientY - startY;

		// TODO: Aspect Ratio!

		clearTimeout(debounce);

		if (resize) {
			let newWidth = startDimension.width + diffX;
			let newHeight = startDimension.height + diffY;
			newWidth = Math.min(
				maxDimension.width,
				Math.max(minDimension.width, newWidth)
			);
			newHeight = Math.min(
				maxDimension.height,
				Math.max(minDimension.height, newHeight)
			);

			widget.options.dimension.width = newWidth;
			widget.options.dimension.height = newHeight;
			widget.updateDimension();
			debounce = setTimeout(() =&gt; widget.onResize(), EMIT_TIMEOUT);
		} else {
			widget.options.position.top = startPosition.top + diffY;
			widget.options.position.left = startPosition.left + diffX;
			widget.updatePosition();
			debounce = setTimeout(() =&gt; widget.onMove(), EMIT_TIMEOUT);
		}
	};

	const mouseup = (ev) =&gt; {
		window.removeEventListener(&quot;mousemove&quot;, mousemove);
		window.removeEventListener(&quot;mouseup&quot;, mouseup);

		widget.$element.classList.remove(&quot;active&quot;);
		$root.setAttribute(&quot;data-window-action&quot;, String(false));

		widget.saveSettings();
	};

	window.addEventListener(&quot;mousemove&quot;, mousemove);
	window.addEventListener(&quot;mouseup&quot;, mouseup);

	widget.$element.classList.add(&quot;active&quot;);
	$root.setAttribute(&quot;data-window-action&quot;, String(true));
};

export const clampPosition = (rect, { dimension, position }) =&gt; {
	const maxLeft = rect.width - dimension.width;
	const maxTop = rect.height - dimension.height;

	return {
		left: Math.max(0, Math.min(maxLeft, position.left)),
		top: Math.max(0, Math.max(rect.top, Math.min(maxTop, position.top))),
	};
};

export default class Widget {
	/**
	 * Creates a new Widget instance.
	 * @param {Core} core MeeseOS Core instance reference
	 * @param {Object} options The options from the provider create function (usually settings storage result)
	 * @param {Object} [attrs] Widget attributes
	 * @param {Object} [settings] A set of defaults for the settings storage
	 */
	constructor(core, options, attrs = {}, settings = {}) {
		this.core = core;
		this.dialog = null;
		this.$element = document.createElement(&quot;div&quot;);
		this.$canvas = document.createElement(&quot;canvas&quot;);
		this.context = this.$canvas.getContext(&quot;2d&quot;);
		this.destroyed = false;
		this.saveDebounce = null;
		this.attributes = {
			aspect: false,
			canvas: true,
			fps: 1,
			position: {
				top: null,
				left: null,
				right: null,
				bottom: null,
			},
			dimension: {
				width: MIN_WIDTH,
				height: MIN_HEIGHT,
			},
			minDimension: null,
			maxDimension: {
				width: MAX_WIDTH,
				height: MAX_HEIGHT,
			},
			...attrs,
		};

		if (this.attributes.minDimension === null) {
			this.attributes.minDimension = {
				width: MIN_WIDTH,
				height: MIN_HEIGHT,
				...this.attributes.dimension,
			};
		}

		if (this.attributes.aspect === true) {
			const { width, height } = this.attributes.dimension;
			const { maxDimension } = this.attributes;
			const aspect = width / height;

			this.attributes.aspect = aspect;
			this.attributes.minDimension.height = width / aspect;
			this.attributes.maxDimension.height = maxDimension.width * aspect;
		}

		this.options = {
			position: { ...this.attributes.position },
			dimension: { ...this.attributes.dimension },
			...settings,
			...options,
		};
	}

	/**
	 * Destroys the widget instance.
	 */
	destroy() {
		if (this.destroyed) return;
		this.destroyed = true;
		this.onDestroy();

		this.saveDebounce = clearTimeout(this.saveDebounce);

		if (this.dialog) {
			this.dialog.destroy();
		}

		if (this.$element &amp;&amp; this.$element.parentNode) {
			this.$element.remove();
		}

		this.$canvas = null;
		this.$element = null;
		this.context = null;
		this.dialog = null;
		this.options = {};
		this.attributes = {};
	}

	render(_viewport) {}

	start() {
		const { width, height } = this.options.dimension;
		const render = () =&gt;
			this.render({
				width: width ? width : 0,
				height: height ? height : 0,
				canvas: this.$canvas,
				context: this.context,
			});

		this.updateDimension();
		this.updatePosition();
		this.onResize();
		this.onMove();

		render();

		if (this.attributes.canvas) {
			animator(this.attributes.fps, () =&gt; this.destroyed)(() =&gt; render());
		}

		setTimeout(() =&gt; this.clampToViewport(), 100);
	}

	/**
	 * Initializes the widget instance.
	 */
	init() {
		const $root = this.core.$contents;
		const resizer = document.createElement(&quot;div&quot;);
		resizer.classList.add(&quot;meeseOS-widget-resize&quot;);

		this.$element.appendChild(resizer);
		this.$element.addEventListener(&quot;mousedown&quot;, (ev) =&gt;
			onmousedown(ev, $root, this)
		);
		this.$element.addEventListener(&quot;contextmenu&quot;, (ev) =&gt;
			this.onContextMenu(ev)
		);
		this.$element.classList.add(&quot;meeseOS-widget&quot;);
		$root.appendChild(this.$element);

		if (this.attributes.canvas) {
			this.$element.appendChild(this.$canvas);
		}

		this.start();
	}

	/**
	 * Updates the widget dimensions.
	 */
	updateDimension() {
		if (this.destroyed) return;

		const { width, height } = this.options.dimension;
		this.$element.style.width = String(width) + &quot;px&quot;;
		this.$element.style.height = String(height) + &quot;px&quot;;
		if (this.attributes.canvas) {
			this.$canvas.width = width;
			this.$canvas.height = height;
		}
	}

	/**
	 * Updates the widget position.
	 */
	updatePosition() {
		if (this.destroyed) return;

		const { left, right, top, bottom } = getPosition(
			this.core,
			this.options.position,
			&quot;auto&quot;
		);
		const getValue = (val) =&gt; (typeof val === &quot;string&quot; ? val : `${val}px`);

		this.$element.style.left = getValue(left);
		this.$element.style.right = getValue(right);
		this.$element.style.top = getValue(top);
		this.$element.style.bottom = getValue(bottom);
	}

	/**
	 * Saves the widget settings.
	 */
	saveSettings() {
		this.saveDebounce = clearTimeout(this.saveDebounce);
		this.saveDebounce = setTimeout(
			() =&gt; this.core.make(&quot;meeseOS/widgets&quot;).save(),
			100
		);
	}

	getContextMenu() {
		return [];
	}

	onDestroy() {}

	onResize() {}

	onMove() {}

	onContextMenu(ev) {
		const menu = [
			...this.getContextMenu(),
			{
				label: &quot;Remove Widget&quot;,
				onclick: () =&gt; {
					this.core.make(&quot;meeseOS/widgets&quot;).remove(this);
					this.core.make(&quot;meeseOS/widgets&quot;).save();
				},
			},
		];

		this.core.make(&quot;meeseOS/contextmenu&quot;).show({
			position: ev,
			menu,
		});
	}

	_createDialog(options, callbackRender, callbackValue) {
		if (this.dialog) {
			return false;
		}

		const callbackButton = (btn, callbackOptions) =&gt; {
			if (btn === &quot;ok&quot;) {
				this.options = merge(this.options, callbackOptions);
				this.saveSettings();
			}
		};

		const dialogOptions = {
			buttons: [&quot;ok&quot;, &quot;cancel&quot;],
			window: options || {},
		};

		this.dialog = this.core
			.make(&quot;meeseOS/dialogs&quot;)
			.create(dialogOptions, callbackValue, callbackButton)
			.render(callbackRender);

		this.dialog.win.on(&quot;destroy&quot;, () =&gt; (this.dialog = null));

		return this.dialog;
	}

	clampToViewport() {
		const { top, left } = this.options.position;
		const rect = this.core.make(&quot;meeseOS/desktop&quot;).getRect();
		const pos = clampPosition(rect, this.options);

		if ((pos &amp;&amp; pos.left) !== left || (pos &amp;&amp; pos.top !== top)) {
			this.options.position = { ...pos };
			this.updatePosition();
		}
	}

	static metadata() {
		return {
			title: undefined,
		};
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
